version: 3

tasks:
  clean:
    desc: Clean
    cmds:
      - rm -rf dist

  build:
    desc: Build
    cmds:
      - goreleaser --snapshot --clean

  build-single:
    desc: Build (single)
    cmds:
      - goreleaser build --snapshot --clean --single-target --output dist/hydra-login-consent-test

  dependencyUpdates:
    desc: Show dependency updates
    cmds:
      - go mod download
      - go mod tidy
      - go list -u -m -json all | go run github.com/psampaz/go-mod-outdated@v0.9.0 -update -direct

  run:
    desc: Run
    deps: [ build-single ]
    cmds:
      - dist/hydra-login-consent-test serve --config-file config.toml

  start-hydra:
    desc: Start hydra
    cmds:
      - docker run -it --rm
        --name ory_hydra_test
        -p 4444:4444
        -p 4445:4445
        -e DSN=memory
        -e SECRETS_COOKIE=some-cookie-secret
        -e SECRETS_SYSTEM=some-system-secret
        -e URLS_SELF_PUBLIC=http://127.0.0.1:4444/
        -e URLS_SELF_ADMIN=http://127.0.0.1:4445/
        -e URLS_SELF_ISSUER=http://127.0.0.1:4444/
        -e URLS_LOGIN=http://127.0.0.1:3001/login
        -e URLS_CONSENT=http://127.0.0.1:3001/consent
        -e URLS_LOGOUT=http://127.0.0.1:3001/logout
        -e URLS_ERROR=http://127.0.0.1:3001/error
        -e URLS_POST_LOGOUT_REDIRECT=http://127.0.0.1:3001/logout-successful
        docker.io/oryd/hydra:v2.1
        serve all --dev

  create-client:
    desc: Create hydra client
    cmds:
      - docker run -it --rm
        --network host
        docker.io/oryd/hydra:v2.1
        create client
        --endpoint http://127.0.0.1:4445/
        --grant-type authorization_code,refresh_token
        --response-type code,id_token
        --scope openid
        --scope email
        --scope profile
        --scope offline_access
        --name gologin-test-app
        --client-uri http://127.0.0.1:8080
        --redirect-uri http://127.0.0.1:8080/oauth2/oidc/callback
